# -*- coding: utf-8 -*-
"""alignment_based_search.ipynb

Automatically generated by Colab.

Original file is located at
    https://colab.research.google.com/drive/1EMInfndspa9i-SCir2AkXv6bB6zeCbBI
"""

!apt install ncbi-blast+ -y
!pip install biopython pandas

"""DNA or Protein sequence character sequence search for similarity"""

from Bio import SeqIO
from Bio.Seq import Seq
from Bio.SeqRecord import SeqRecord

# Healty sequence
healthy_seq = SeqRecord(
    Seq("ATGGCCATTGTAATGGGCCGCTGAAAGGGTGCCCGATAG"),
    id="Healthy_1",
    description="Healthy gene"
)

# Cancer-like cell version
cancer_seq = SeqRecord(
    Seq("ATGGCCATTGTAGTGGGCCGCTGAAAGGGTACCCGATAG"),
    id="Cancer_1",
    description="Mutated (Cancer) gene"
)

# Save FASTA file
SeqIO.write([healthy_seq, cancer_seq], "samples.fasta", "fasta")
print("Sample FASTA file created.")

!makeblastdb -in samples.fasta -dbtype nucl -out cancerdb
!blastn -query samples.fasta -db cancerdb -out results.txt -outfmt 7

import pandas as pd

# Reading BLAST output
with open("results.txt") as f:
    lines = [line.strip() for line in f if not line.startswith("#") and line.strip()]

data = []
for line in lines:
    parts = line.split("\t")
    data.append({
        "Query": parts[0],
        "Subject": parts[1],
        "Identity(%)": float(parts[2]),
        "Alignment Length": int(parts[3]),
        "Mismatches": int(parts[4]),
    })

df = pd.DataFrame(data)
df

from Bio import pairwise2
from Bio.pairwise2 import format_alignment

alignments = pairwise2.align.globalxx(healthy_seq.seq, cancer_seq.seq)
print(format_alignment(*alignments[0]))

matches = sum(a == b for a, b in zip(healthy_seq.seq, cancer_seq.seq))
score = matches / len(healthy_seq.seq)
print(f"Cancer Validation Similarity: {score*100:.2f}%")

if score < 0.95:
    print(" Potential Cancer Mutation Detected.")
else:
    print(" Sequence appears normal.")

"""

# Here is more complicated as Pipeline Level


"""

!apt install ncbi-blast+ -y
!pip install biopython pandas

"""# Cancer Genes dataset collection from NCBI [BRCA1, TP53, KRAS]"""

from Bio import Entrez, SeqIO

Entrez.email = "example@mail.com"  # NCBI

# Cancer related 3 gen: BRCA1, TP53, KRAS
GENE_IDS = ["NM_007294", "NM_000546", "NM_004985"]

records = []
for gid in GENE_IDS:
    handle = Entrez.efetch(db="nucleotide", id=gid, rettype="fasta", retmode="text")
    record = SeqIO.read(handle, "fasta")
    records.append(record)
    print(f" Downloaded: {record.id}")

SeqIO.write(records, "cancer_reference_genes.fasta", "fasta")
print("\n Reference cancer genes saved to cancer_reference_genes.fasta")

# Print details of each downloaded gene
for record in records:
    print(f"ID: {record.id}")
    print(f"Name: {record.name}")
    print(f"Description: {record.description}")
    print(f"Sequence length: {len(record.seq)}")
    print("-" * 20)



"""## Genes come from patient DNA Sequence
A small mutation added
"""

from Bio.Seq import Seq
from Bio.SeqRecord import SeqRecord
from Bio import SeqIO

# BRCA1 gene 12 base reference sequence
ref_seq = "ATGGGACTGCTTCTTAGTGGCTGGACAGCAGTTTGTGTTTTGAGGTTTTTGTAGAGGATGGGCTTTCAGTTTTAAAGGAACTTCTGGTGAAGAGTGGAAGAGTGAAGAGCTGAGGAAGAGGAAGAG"

# 3 mutation version
# 1. 30. base G -> T
# 2. 60. base deleted
# 3. 90. base "CC" added
mutated = list(ref_seq)
mutated[29] = "T"       # substitution
del mutated[59]          # deletion
mutated.insert(90, "C")  # insertion
mutated.insert(91, "C")

mutated_seq = "".join(mutated)

patient_sample = SeqRecord(
    Seq(mutated_seq),
    id="Patient_BRCA1_mut120",
    description="Simulated BRCA1 cancer-like variant (120bp, with 3 mutations)"
)

SeqIO.write([patient_sample], "patient_sample.fasta", "fasta")
print("Mutated cancer-like 120bp BRCA1 FASTA created.")
print("First 80 bp:", mutated_seq[:80])

"""Dataset generation"""

!makeblastdb -in cancer_reference_genes.fasta -dbtype nucl -out cancer_ref_db

"""Alignment - Patient DNA and cancer genes comparison"""

!blastn -task blastn-short -query patient_sample.fasta -db cancer_ref_db -out results.txt -outfmt "6 qseqid sseqid pident length bitscore evalue"

"""Result read and analysis, blast output, identity, alignment length, mismatch and gap numbers"""

import pandas as pd

# BLAST columns
cols = ["Query_ID", "Matched_Gene", "Identity(%)", "Alignment_Length", "Bitscore", "Evalue"]

df = pd.read_csv("results.txt", sep="\t", names=cols)

if df.empty:
    print(" No significant BLAST hits found(short sequence its normal)")
else:
    display(df)

def interpret_identity(val):
    if val >= 99:
        return "Normal / Reference match"
    elif val >= 95:
        return "Mild variant (Benign)"
    else:
        return "Potential cancer mutation"

if not df.empty:
    df["Interpretation"] = df["Identity(%)"].apply(interpret_identity)
    display(df)

import json

if not df.empty:
    df.to_csv("Cancer_Validation_Report.csv", index=False)
    with open("Cancer_Validation_Report.json", "w") as f:
        json.dump(df.to_dict(orient="records"), f, indent=4)
    print("Cancer_Validation_Report.csv / .json kaydedildi.")

